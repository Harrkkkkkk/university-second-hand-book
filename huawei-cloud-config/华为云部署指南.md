# 校园二手书交易平台华为云部署指南

## 1. 华为云资源准备

### 1.1 购买华为云RDS数据库

#### 步骤1：登录华为云控制台
1. 访问华为云官网：https://www.huaweicloud.com/
2. 登录华为云账号
3. 进入控制台

#### 步骤2：购买RDS实例
1. 进入RDS服务页面
2. 选择规格：
   - 数据库类型：MySQL
   - 版本：5.7或8.0
   - 规格：通用增强型，2vCPUs | 4GB
   - 存储空间：40GB
3. 网络配置：
   - VPC：选择合适的VPC
   - 安全组：确保开放3306端口
   - 子网：与ECS在同一可用区
4. 设置数据库密码
5. 数据库名称：`wisebookpal`
6. 点击"立即购买"

### 1.2 购买华为云ECS云服务器

#### 步骤1：购买ECS实例
1. 进入ECS服务页面
2. 选择规格：
   - 镜像：CentOS 7.6 64bit
   - 规格：通用计算增强型，4vCPUs | 8GB
   - 系统盘：40GB
3. 网络配置：
   - VPC：与RDS相同VPC
   - 安全组：开放8080端口（应用端口）
   - 公网带宽：按需选择
4. 设置登录密码
5. 实例名称：`ecs-book`
6. 点击"立即购买"

## 2. 环境配置

### 2.1 git clone项目到云服务器

```bash
# 在云服务器/home目录下执行
git clone -b ecs https://github.com/Harrkkkkkk/university-second-hand-book.git book-platform

```

### 2.2 安装Java环境

```bash
# 安装OpenJDK 21
wget https://cdn.azul.com/zulu/bin/zulu21.32.17-ca-jdk21.0.2-linux_aarch64.tar.gz
tar -xzf zulu21.32.17-ca-jdk21.0.2-linux_aarch64.tar.gz
sudo mv zulu21.32.17-ca-jdk21.0.2-linux_aarch64 /usr/lib/jvm/java-21
sudo tee /etc/profile.d/java21.sh << 'EOF'
export JAVA_HOME=/usr/lib/jvm/java-21
export PATH=$JAVA_HOME/bin:$PATH
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
echo 'export JAVA_HOME=/usr/lib/jvm/java-21' >> ~/.bashrc
echo 'export PATH=$JAVA_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
EOF

source /etc/profile.d/java21.sh

# 验证Java安装
java -version

# 验证Javac版本
javac -version

# 检查JAVA_HOME
echo $JAVA_HOME

# 查看完整Java路径
which java
readlink -f $(which java)
```

### 2.3 安装Maven

```bash
# 创建Maven安装目录
mkdir /usr/local/maven
wget http://mirrors.huaweicloud.com/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
# 下载Maven（如果本地有Maven包，可以上传）
cd /usr/local/maven
# 如果有本地的Maven包，可以解压使用
tar -xzf apache-maven-3.6.3-bin.tar.gz

# 配置环境变量
echo 'export MAVEN_HOME=/usr/local/maven/apache-maven-3.6.3' >> /etc/profile
echo 'export PATH=$MAVEN_HOME/bin:$PATH' >> /etc/profile
source /etc/profile

# 验证Maven安装
mvn -version
```

## 3. 应用部署

### 3.1 准备项目文件

1. 准备配置文件：
   - 将huawei-cloud-config目录下的以下文件移动到 `/home/book-platform/` 目录：
     - `mysql_init.sql` (数据库初始化脚本)
     - `startup.sh`(启动脚本)
     - `book-platform.service`(服务配置文件)
   - 用huawei-cloud-config目录下的`application.yml`替换 `/home/book-platform/backend/src/main/application.yml`

2. 在云服务器上使用Maven构建项目：
```bash
cd backend
mvn clean package -DskipTests
cp book-api-0.0.1-SNAPSHOT.jar /home/book-platform/
```

### 3.2 配置应用

#### 修改数据库配置
编辑 `application.yml` 文件，修改数据库连接信息：

```yaml
spring:
  datasource:
    url: jdbc:mysql://rds内网地址:3306/wisebookpal?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
    username: root
    password: your-rds-password  # 替换为实际的RDS密码
```

**获取RDS内网地址：**
1. 登录华为云控制台
2. 进入RDS服务页面
3. 点击创建的RDS实例
4. 在"连接信息"中查看"内网地址"

### 3.3 初始化数据库

#### 导入数据库脚本
使用MySQL客户端连接RDS数据库：
```bash
yum install -y mysql
cd /home/book-platform
mysql -h 192.168.249.147 -u root -paA123456bookpal

CREATE DATABASE IF NOT EXISTS wisebookpal DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
SHOW DATABASES;
EXIT;

mysql -h 192.168.249.147 -u root -paA123456bookpal wisebookpal < mysql_init.sql
```


### 3.4 设置权限和目录

```bash
# 创建项目目录
mkdir -p /home/book-platform/logs
mkdir -p /home/book-platform/uploads

# 设置目录权限
chmod +x /home/book-platform/startup.sh
chown -R root:root /home/book-platform
```

## 4. 服务配置

#### 4.1 开放8080端口
```bash
firewall-cmd --permanent --add-port=8080/tcp
firewall-cmd --reload
```

### 4.2 配置systemd服务

1. 复制服务配置文件：
```bash
cp book-platform.service /etc/systemd/system/
```

2. 重新加载systemd配置：
```bash
systemctl daemon-reload
```

3. 启用开机自启动：
```bash
systemctl enable book-platform.service
```

### 4.3 启动应用

```bash
# 启动服务
systemctl start book-platform.service

# 查看服务状态
systemctl status book-platform.service

# 查看应用日志
journalctl -u book-platform.service -f
```

## 5. 验证部署

### 5.1 检查应用状态

```bash
# 检查Java进程
ps aux | grep java

# 检查端口占用
netstat -tulpn | grep 8080

# 检查服务状态
systemctl status book-platform.service
```

### 5.2 测试数据库连接

```bash
# 测试MySQL连接
mysql -h rds内网地址 -u root -p -e "SELECT COUNT(*) FROM wisebookpal.users;"
```

后端部署完成后，按照前端部署指南中的步骤部署前端应用。