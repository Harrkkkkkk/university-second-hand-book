# 云服务器操作指南 - 获取缺失文件

## 情况说明
云服务器上缺少以下文件：
- book-api-0.0.1-SNAPSHOT.jar
- book-platform.service

## 解决方案

### 方案一：在云服务器上构建JAR包

#### 步骤1：下载Maven并安装
```bash
# 创建目录
mkdir -p /usr/local/maven

# 下载Maven
cd /usr/local/maven
wget http://mirrors.huaweicloud.com/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz

# 解压
tar -xzf apache-maven-3.6.3-bin.tar.gz

# 配置环境变量
echo 'export MAVEN_HOME=/usr/local/maven/apache-maven-3.6.3' >> /etc/profile
echo 'export PATH=$MAVEN_HOME/bin:$PATH' >> /etc/profile

# 重新加载环境变量
source /etc/profile

# 验证安装
mvn -version
```

#### 步骤2：下载项目源代码
```bash
# 进入项目目录
cd /home/book-platform

# 如果项目还没有源代码，需要先获取
# 方法1：如果有Git仓库
# git clone <your-repository-url>

# 方法2：上传源代码包并解压
# 使用WinSCP等工具上传源码包并解压
```

#### 步骤3：构建JAR包
```bash
# 进入backend目录
cd backend

# 构建项目
mvn clean package -DskipTests

# 复制生成的JAR包到项目根目录
cp target/book-api-0.0.1-SNAPSHOT.jar /home/book-platform/
```

### 方案二：从本地上传文件

#### 步骤1：获取book-platform.service文件
将以下内容保存为 `book-platform.service` 文件并上传到云服务器：

```ini
[Unit]
Description=Book Platform API Service
After=network.target

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=/home/book-platform
ExecStart=/bin/bash /home/book-platform/startup.sh
ExecStop=/bin/bash -c 'if [ -f /tmp/book-platform.pid ]; then kill $(cat /tmp/book-platform.pid); rm /tmp/book-platform.pid; fi'
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=book-platform

[Install]
WantedBy=multi-user.target
```

#### 步骤2：获取JAR包
在本地项目中构建JAR包：
```bash
cd backend
mvn clean package -DskipTests
```

然后将 `backend/target/book-api-0.0.1-SNAPSHOT.jar` 上传到云服务器的 `/home/book-platform/` 目录。

## 完整操作步骤

### 1. 设置环境
```bash
# 安装Java 21（如果还没安装）
yum install -y java-21-openjdk java-21-openjdk-devel

# 设置JAVA_HOME
export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
echo "export JAVA_HOME=$JAVA_HOME" >> /etc/profile
echo "export PATH=\$JAVA_HOME/bin:\$PATH" >> /etc/profile
source /etc/profile
```

### 2. 获取缺失文件
```bash
# 进入项目目录
cd /home/book-platform

# 创建缺失的文件
# (按照上面的方案一或方案二操作)
```

### 3. 设置权限
```bash
# 设置文件权限
chmod +x startup.sh
chown -R root:root /home/book-platform
```

### 4. 配置数据库
```bash
# 编辑配置文件
nano application-cloud.yml

# 修改以下内容：
# spring.datasource.url 中的 rds-oa-internal-ip 替换为实际RDS地址
# spring.datasource.password 替换为实际密码
```

### 5. 初始化数据库
```bash
# 连接RDS并初始化
mysql -h 192.168.249.147 -u root -paA123456bookpal wisebookpal < mysql_init.sql
```

### 6. 配置服务
```bash
# 复制服务文件
cp book-platform.service /etc/systemd/system/

# 重新加载systemd配置
systemctl daemon-reload

# 启用开机自启动
systemctl enable book-platform.service
```

### 7. 启动应用
```bash
# 启动服务
systemctl start book-platform.service

# 查看状态
systemctl status book-platform.service

# 查看日志
journalctl -u book-platform.service -f
```

### 8. 验证部署
```bash
# 检查进程
ps aux | grep java

# 检查端口
netstat -tulpn | grep 8080

# 测试访问
curl http://localhost:8080/book-api
```

## 故障排除

### 如果Maven下载失败
```bash
# 使用华为云镜像源
wget https://repo1.maven.org/maven2/org/apache/maven/apache-maven/3.6.3/apache-maven-3.6.3-bin.tar.gz -O apache-maven-3.6.3-bin.tar.gz
```

### 如果构建失败
```bash
# 检查Java版本
java -version

# 检查Maven配置
mvn -X

# 清理并重新构建
mvn clean
mvn compile
mvn package -DskipTests
```

### 如果服务启动失败
```bash
# 查看详细错误信息
journalctl -u book-platform.service --no-pager

# 手动执行启动脚本测试
cd /home/book-platform
./startup.sh
```

## 注意事项

1. 确保RDS和ECS在同一VPC中
2. 检查安全组配置，开放8080端口
3. 确保数据库连接信息正确
4. 建议在测试环境先验证部署流程